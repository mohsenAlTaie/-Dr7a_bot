import os
import random
import logging
import time
import subprocess
import sqlite3
from telegram import Update, InlineKeyboardMarkup, InlineKeyboardButton
from telegram.constants import ParseMode
from telegram.ext import Application, CommandHandler, MessageHandler, CallbackQueryHandler, filters, ContextTypes, ConversationHandler
import yt_dlp

logging.basicConfig(format="%(asctime)s - %(name)s - %(levelname)s - %(message)s", level=logging.INFO)

TOKEN = "7552405839:AAF8Pe8sTJnrr-rnez61HhxnwAVsth2IuaU"
BOT_USERNAME = "Dr7a_bot"
ADMIN_ID = 7249021797

if not os.path.exists("downloads"):
    os.makedirs("downloads")

if not os.path.exists("vip_users.db"):
    conn = sqlite3.connect("vip_users.db")
    cursor = conn.cursor()
    cursor.execute("CREATE TABLE IF NOT EXISTS vip_users (user_id INTEGER PRIMARY KEY)")
    conn.commit()
    conn.close()

weird_messages = [
    "ğŸ‘½ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ ÙƒØ§Ø¦Ù†Ø§Øª TikTok Ø§Ù„ÙØ¶Ø§Ø¦ÙŠØ©...",
    "ğŸ”® ÙØªØ­ Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø²Ù…Ù† Ø§Ù„Ø±Ù‚Ù…ÙŠ...",
    "ğŸ§ª Ø®Ù„Ø· ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª TikTok ÙÙŠ Ø§Ù„Ù…Ø®ØªØ¨Ø± Ø§Ù„Ø³Ø±ÙŠ...",
    "ğŸ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ØªÙ†ÙŠÙ† TikTok Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ...",
    "ğŸ“¡ Ø§Ù„ØªÙ‚Ø§Ø· Ø¥Ø´Ø§Ø±Ø© Ù…Ù† Ø³ÙŠØ±ÙØ±Ø§Øª Ø§Ù„ØµÙŠÙ†...",
    "ğŸš€ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ø³Ø±Ø¹Ø© ØªØªØ¬Ø§ÙˆØ² Ø³Ø±Ø¹Ø© Ø§Ù„Ø¶ÙˆØ¡... ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§",
    "ğŸ§  Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù„ÙÙƒ Ø´ÙŠÙØ±Ø© Ø§Ù„Ø±Ø§Ø¨Ø·...",
    "ğŸ’¿ Ø¥Ø¯Ø®Ø§Ù„ Ù‚Ø±Øµ TikTok Ø¯Ø§Ø®Ù„ Ù…Ø´ØºÙ„ VHS Ø§Ù„ÙØ¶Ø§Ø¦ÙŠ...",
    "ğŸ‘¾ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø±ÙˆØ¨ÙˆØª Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø¨Ø¹Ø¯ Ø¢Ø®Ø±...",
    "ğŸ• Ø±Ø´ Ø¬Ø¨Ù†Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†ÙƒÙ‡Ø© Ø£ÙØ¶Ù„ Ù„Ù„ÙÙŠØ¯ÙŠÙˆ...",
    "ğŸ© ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¥Ù„Ù‰ Ø£Ø±Ù†Ø¨ ÙˆØ³Ø­Ø¨Ù‡ Ù…Ù† Ø§Ù„Ù‚Ø¨Ø¹Ø©...",
    "ğŸ¢ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ... Ø¨Ø³Ø±Ø¹Ø© Ø³Ù„Ø­ÙØ§Ø© Ù†ÙŠÙ†Ø¬Ø§ ğŸ¢ (Ø§Ù…Ø²Ø­ØŒ Ù‡Ùˆ Ø³Ø±ÙŠØ¹!)"
]

user_timestamps = {}
ADD, REMOVE = range(2)

def add_vip(user_id):
    with sqlite3.connect("vip_users.db") as conn:
        conn.execute("INSERT OR IGNORE INTO vip_users (user_id) VALUES (?)", (user_id,))
        conn.commit()

def remove_vip(user_id):
    with sqlite3.connect("vip_users.db") as conn:
        conn.execute("DELETE FROM vip_users WHERE user_id = ?", (user_id,))
        conn.commit()

def list_vips():
    with sqlite3.connect("vip_users.db") as conn:
        cursor = conn.execute("SELECT user_id FROM vip_users")
        return [str(row[0]) for row in cursor.fetchall()]

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        [InlineKeyboardButton("â• Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø¨ÙˆØª", url=f"https://t.me/share/url?url=https://t.me/{BOT_USERNAME}")],
        [InlineKeyboardButton("ğŸ§‘â€ğŸ’» Ø§Ù„Ù…Ø·ÙˆØ±", url="https://t.me/K0_MG")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    welcome_message = (
        "ğŸ‘â€ğŸ—¨âœ¨ *Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ø¨ÙØ¹Ø¯ Ø§Ù„Ø¢Ø®Ø± Ù…Ù† Ø§Ù„ØªØ­Ù…ÙŠÙ„!*

"
        "Ù‡Ù„ Ø£Ù†Øª Ù…Ø³ØªØ¹Ø¯Ù‘ Ù„Ø§Ø®ØªØ±Ø§Ù‚ Ø¹ÙˆØ§Ù„Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§ØªØŸ ğŸš€ğŸ“¥
"
        "ğŸ“ ÙÙ‚Ø· Ø£Ø±Ø³Ù„ Ø§Ù„Ø±Ø§Ø¨Ø·ØŒ ÙˆØ³Ø£Ù‚ÙˆÙ… Ø¨Ø§Ù„Ø¨Ø§Ù‚ÙŠ... ğŸ’¼ğŸ¤–

"
        "ğŸ› ï¸ *ØªÙ… Ø¨Ù†Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª Ø¨Ø¹Ù†Ø§ÙŠØ© Ø¨ÙˆØ§Ø³Ø·Ø© Ù…Ø­Ø³Ù† Ø¹Ù„ÙŠ Ø­Ø³ÙŠÙ†* ğŸ®ğŸ’»"
    )
    await update.message.reply_text(welcome_message, reply_markup=reply_markup, parse_mode=ParseMode.MARKDOWN)

async def admin_panel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.effective_user.id != ADMIN_ID:
        await update.message.reply_text("âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ….")
        return
    keyboard = [
        [InlineKeyboardButton("â• Ø¥Ø¶Ø§ÙØ© Ù…Ø´ØªØ±Ùƒ", callback_data="add_user")],
        [InlineKeyboardButton("â– Ø­Ø°Ù Ù…Ø´ØªØ±Ùƒ", callback_data="remove_user")],
        [InlineKeyboardButton("ğŸ‘ï¸ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†", callback_data="list_users")]
    ]
    await update.message.reply_text("ğŸ“‹ *Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©:*", reply_markup=InlineKeyboardMarkup(keyboard), parse_mode=ParseMode.MARKDOWN)

async def control_callbacks(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    data = query.data
    if update.effective_user.id != ADMIN_ID:
        await query.edit_message_text("âŒ Ù„Ø§ ØªÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ù‡ Ø§Ù„Ø£Ø²Ø±Ø§Ø±.")
        return
    if data == "add_user":
        await query.edit_message_text("ğŸŸ¢ Ø£Ø±Ø³Ù„ Ø¢ÙŠØ¯ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¥Ø¶Ø§ÙØªÙ‡ ÙƒÙ…Ø´ØªØ±Ùƒ.")
        return ADD
    elif data == "remove_user":
        await query.edit_message_text("ğŸ”´ Ø£Ø±Ø³Ù„ Ø¢ÙŠØ¯ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø­Ø°ÙÙ‡ Ù…Ù† Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†.")
        return REMOVE
    elif data == "list_users":
        users = list_vips()
        text = "ğŸ‘ï¸ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†:
" + "
".join(users) if users else "âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´ØªØ±ÙƒÙŠÙ†."
        await query.edit_message_text(text)

async def handle_add(update: Update, context: ContextTypes.DEFAULT_TYPE):
    try:
        user_id = int(update.message.text.strip())
        add_vip(user_id)
        await update.message.reply_text(f"âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© {user_id} Ù„Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†.")
    except:
        await update.message.reply_text("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£. ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø¢ÙŠØ¯ÙŠ ØµØ­ÙŠØ­.")
    return ConversationHandler.END

async def handle_remove(update: Update, context: ContextTypes.DEFAULT_TYPE):
    try:
        user_id = int(update.message.text.strip())
        remove_vip(user_id)
        await update.message.reply_text(f"ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù {user_id} Ù…Ù† Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†.")
    except:
        await update.message.reply_text("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£. ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø¢ÙŠØ¯ÙŠ ØµØ­ÙŠØ­.")
    return ConversationHandler.END

async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("âŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.")
    return ConversationHandler.END

async def handle_video(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    now = time.time()
    url = update.message.text.strip()
    if user_id in user_timestamps and now - user_timestamps[user_id] < 10:
        await update.message.reply_text("â³ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù‚Ø¨Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¬Ø¯ÙŠØ¯.")
        return
    user_timestamps[user_id] = now
    if not any(site in url for site in ["youtube.com", "youtu.be", "facebook.com", "fb.watch", "instagram.com", "tiktok.com"]):
        await update.message.reply_text("âŒ Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ….")
        return
    if "tiktok.com" in url:
        await update.message.reply_text(random.choice(weird_messages) + "
â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ...")
        try:
            ydl_opts = {'outtmpl': 'downloads/%(id)s.%(ext)s', 'format': 'mp4', 'quiet': True}
            with yt_dlp.YoutubeDL(ydl_opts) as ydl:
                info = ydl.extract_info(url, download=True)
                file_path = ydl.prepare_filename(info)
            await update.message.reply_video(video=open(file_path, 'rb'))
            os.remove(file_path)
        except Exception as e:
            await update.message.reply_text(f"âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„:
{e}")
        return
    await update.message.reply_text("ğŸ“¥ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...")
    try:
        file_path = "downloads/video.mp4"
        subprocess.run(["yt-dlp", "-f", "mp4", "-o", file_path, url], check=True)
        if os.path.exists(file_path):
            await update.message.reply_video(video=open(file_path, "rb"))
            os.remove(file_path)
        else:
            await update.message.reply_text("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù.")
    except Exception as e:
        await update.message.reply_text(f"âŒ Ø®Ø·Ø£:
{e}")

def main():
    app = Application.builder().token(TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("admin", admin_panel))
    app.add_handler(CallbackQueryHandler(control_callbacks))
    conv_handler = ConversationHandler(
        entry_points=[CallbackQueryHandler(control_callbacks)],
        states={
            ADD: [MessageHandler(filters.TEXT & ~filters.COMMAND, handle_add)],
            REMOVE: [MessageHandler(filters.TEXT & ~filters.COMMAND, handle_remove)]
        },
        fallbacks=[CommandHandler("cancel", cancel)]
    )
    app.add_handler(conv_handler)
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_video))
    app.run_polling()

if __name__ == "__main__":
    main()
