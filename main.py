import os
import random
import logging
import time
import subprocess
from datetime import datetime
from telegram import Update, InlineKeyboardMarkup, InlineKeyboardButton
from telegram.constants import ParseMode
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes
import yt_dlp

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù„ÙˆØ¬
logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s", level=logging.INFO
)

# ØªÙˆÙƒÙ† Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ù…ÙˆØ­Ø¯
TOKEN = "7552405839:AAF8Pe8sTJnrr-rnez61HhxnwAVsth2IuaU"
BOT_USERNAME = "Dr7a_bot"

# Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
if not os.path.exists("downloads"):
    os.makedirs("downloads")

# Ø±Ø³Ø§Ø¦Ù„ ØºØ±ÙŠØ¨Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ù„Ù„ØªÙŠÙƒ ØªÙˆÙƒ
weird_messages = [
    "ğŸ‘½ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ ÙƒØ§Ø¦Ù†Ø§Øª TikTok Ø§Ù„ÙØ¶Ø§Ø¦ÙŠØ©...",
    "ğŸ”® ÙØªØ­ Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø²Ù…Ù† Ø§Ù„Ø±Ù‚Ù…ÙŠ...",
    "ğŸ§ª Ø®Ù„Ø· ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª TikTok ÙÙŠ Ø§Ù„Ù…Ø®ØªØ¨Ø± Ø§Ù„Ø³Ø±ÙŠ...",
    "ğŸ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ ØªÙ†ÙŠÙ† TikTok Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ...",
    "ğŸ“¡ Ø§Ù„ØªÙ‚Ø§Ø· Ø¥Ø´Ø§Ø±Ø© Ù…Ù† Ø³ÙŠØ±ÙØ±Ø§Øª Ø§Ù„ØµÙŠÙ†...",
    "ğŸš€ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¨Ø³Ø±Ø¹Ø© ØªØªØ¬Ø§ÙˆØ² Ø³Ø±Ø¹Ø© Ø§Ù„Ø¶ÙˆØ¡... ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§",
    "ğŸ§  Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù„ÙÙƒ Ø´ÙŠÙØ±Ø© Ø§Ù„Ø±Ø§Ø¨Ø·...",
    "ğŸ’¿ Ø¥Ø¯Ø®Ø§Ù„ Ù‚Ø±Øµ TikTok Ø¯Ø§Ø®Ù„ Ù…Ø´ØºÙ„ VHS Ø§Ù„ÙØ¶Ø§Ø¦ÙŠ...",
    "ğŸ‘¾ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø±ÙˆØ¨ÙˆØª Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø¨Ø¹Ø¯ Ø¢Ø®Ø±...",
    "ğŸ• Ø±Ø´ Ø¬Ø¨Ù†Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†ÙƒÙ‡Ø© Ø£ÙØ¶Ù„ Ù„Ù„ÙÙŠØ¯ÙŠÙˆ...",
    "ğŸ© ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¥Ù„Ù‰ Ø£Ø±Ù†Ø¨ ÙˆØ³Ø­Ø¨Ù‡ Ù…Ù† Ø§Ù„Ù‚Ø¨Ø¹Ø©...",
    "ğŸ¢ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ... Ø¨Ø³Ø±Ø¹Ø© Ø³Ù„Ø­ÙØ§Ø© Ù†ÙŠÙ†Ø¬Ø§ ğŸ¢ (Ø§Ù…Ø²Ø­ØŒ Ù‡Ùˆ Ø³Ø±ÙŠØ¹!)"
]

# Ù†Ø¸Ø§Ù… Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ø³Ø¨Ø§Ù…
user_timestamps = {}

# VIP Users
VIP_USERS = [123456789]  # Ø­Ø· Ø§Ù„Ø¢ÙŠØ¯ÙŠ Ø§Ù„Ø®Ø§Øµ Ø¨ÙŠÙƒ Ø£Ùˆ Ø¨Ø£ÙŠ Ù…Ø³ØªØ®Ø¯Ù… VIP Ù‡Ù†Ø§

# Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
daily_limits = {}
DAILY_LIMIT = 30

def reset_daily_limits():
    current_date = datetime.utcnow().date()
    for user_id in list(daily_limits):
        if daily_limits[user_id]["date"] != current_date:
            daily_limits[user_id] = {"count": 0, "date": current_date}

# Ø±Ø³Ø§Ù„Ø© /start Ù…ÙˆØ­Ø¯Ø©
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        [InlineKeyboardButton("â• Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø¨ÙˆØª", url=f"https://t.me/share/url?url=https://t.me/{BOT_USERNAME}")],
        [InlineKeyboardButton("ğŸ§‘â€ğŸ’» Ø§Ù„Ù…Ø·ÙˆØ±", url="https://t.me/K0_MG")],
        [InlineKeyboardButton("ğŸ’ Ø´Ø±Ø§Ø¡ VIP", url="https://t.me/K0_MG")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    welcome_message = (
        "ğŸ‘â€ğŸ—¨âœ¨ *Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ø¨ÙØ¹Ø¯ Ø§Ù„Ø¢Ø®Ø± Ù…Ù† Ø§Ù„ØªØ­Ù…ÙŠÙ„!*\n\n"
        "Ù‡Ù„ Ø£Ù†Øª Ù…Ø³ØªØ¹Ø¯Ù‘ Ù„Ø§Ø®ØªØ±Ø§Ù‚ Ø¹ÙˆØ§Ù„Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ù…Ù† ÙÙŠØ³Ø¨ÙˆÙƒØŒ ÙŠÙˆØªÙŠÙˆØ¨ØŒ Ø¥Ù†Ø³ØªØºØ±Ø§Ù…ØŒ ÙˆØªÙŠÙƒ ØªÙˆÙƒØŸ ğŸš€ğŸ“¥\n"
        "Ù‡Ù†Ø§ Ø­ÙŠØ« ØªÙ†ØµÙ‡Ø± Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ÙˆØªÙˆÙ„Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª! ğŸŒğŸ”¥\n\n"
        "ğŸ“ ÙÙ‚Ø· Ø£Ø±Ø³Ù„ Ø§Ù„Ø±Ø§Ø¨Ø·ØŒ ÙˆØ³Ø£Ù‚ÙˆÙ… Ø¨Ø§Ù„Ø¨Ø§Ù‚ÙŠ... Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ù„Ø´Ø±Ø­ØŒ ÙÙ‚Ø· Ø§Ù„Ø«Ù‚Ø© ğŸ’¼ğŸ¤–\n\n"
        "ğŸ’ Ù„Ø±ÙØ¹ Ø¹Ø¯Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª ÙˆÙØªØ­ Ù…ÙŠØ²Ø§Øª VIP ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¯ÙØ¹ Ø¹Ø¨Ø±:\n"
        "- Ø¢Ø³ÙŠØ§Ø³ÙŠÙ„\n"
        "- Ø²ÙŠÙ† ÙƒØ§Ø´\n"
        "- Ù…Ø§Ø³ØªØ± ÙƒØ§Ø±Ø¯\n\n"
        "ğŸ› ï¸ *ØªÙ… Ø¨Ù†Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª Ø¨Ø¹Ù†Ø§ÙŠØ© Ø¨ÙˆØ§Ø³Ø·Ø© Ù…Ø­Ø³Ù† Ø¹Ù„ÙŠ Ø­Ø³ÙŠÙ†* ğŸ®ğŸ’»"
    )

    await update.message.reply_text(welcome_message, reply_markup=reply_markup, parse_mode=ParseMode.MARKDOWN)

# Ø£Ù…Ø± Ø¹Ø±Ø¶ Ø¹Ø¯Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©
async def usage(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    reset_daily_limits()
    user_data = daily_limits.get(user_id, {"count": 0, "date": datetime.utcnow().date()})
    remaining = DAILY_LIMIT - user_data["count"]
    await update.message.reply_text(f"ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© Ø§Ù„ÙŠÙˆÙ…: {remaining} Ù…Ù† {DAILY_LIMIT}")

# Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„ØªØ­Ù„ÙŠÙ„ ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
async def handle_video(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    now = time.time()
    url = update.message.text.strip()

    # Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ø³Ø¨Ø§Ù… (Ù„ØºÙŠØ± VIP)
    if user_id not in VIP_USERS:
        if user_id in user_timestamps and now - user_timestamps[user_id] < 10:
            await update.message.reply_text("â³ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù‚Ø¨Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¬Ø¯ÙŠØ¯.")
            return
        user_timestamps[user_id] = now

        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ
        reset_daily_limits()
        user_data = daily_limits.get(user_id, {"count": 0, "date": datetime.utcnow().date()})
        if user_data["count"] >= DAILY_LIMIT:
            await update.message.reply_text("ğŸš« ÙˆØµÙ„Øª Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù…Ù† Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© (30). Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ØºØ¯Ù‹Ø§ Ø£Ùˆ Ø§Ù„ØªØ±Ù‚ÙŠØ© Ø¥Ù„Ù‰ VIP.")
            return
        daily_limits[user_id] = {"count": user_data["count"] + 1, "date": datetime.utcnow().date()}

    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
    if not any(site in url for site in ["youtube.com", "youtu.be", "facebook.com", "fb.watch", "instagram.com", "instagram", "tiktok.com"]):
        await update.message.reply_text("âŒ Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…. Ø£Ø±Ø³Ù„ Ø±Ø§Ø¨Ø· Ù…Ù† YouTube Ø£Ùˆ Facebook Ø£Ùˆ Instagram Ø£Ùˆ TikTok.")
        return

    # TikTok Ø¨Ø±Ø³Ø§Ù„Ø© Ø®Ø§ØµØ©
    if "tiktok.com" in url:
        loading_msg = random.choice(weird_messages)
        await update.message.reply_text(f"{loading_msg}\nâ³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ...")
        ydl_opts = {
            'outtmpl': 'downloads/%(id)s.%(ext)s',
            'format': 'mp4',
            'quiet': True,
        }
        try:
            with yt_dlp.YoutubeDL(ydl_opts) as ydl:
                info = ydl.extract_info(url, download=True)
                file_path = ydl.prepare_filename(info)

            await update.message.reply_video(video=open(file_path, 'rb'))
            os.remove(file_path)
        except Exception as e:
            await update.message.reply_text(f"âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† TikTok:\n{str(e)}")
        return

    # Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹
    await update.message.reply_text("ğŸ“¥ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...")

    try:
        file_path = "downloads/video.mp4"
        command = ["yt-dlp", "-f", "mp4"]

        # ÙƒÙˆÙƒÙŠØ² Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹
        if "facebook.com" in url or "fb.watch" in url:
            command += ["--cookies", "facebook_cookies.txt"]
        elif "youtube.com" in url or "youtu.be" in url:
            command += ["--cookies", "youtube_cookies.txt"]
        elif "instagram.com" in url:
            command += ["--cookies", "instagram_cookies.txt"]

        command += ["-o", file_path, url]
        subprocess.run(command, check=True)

        if os.path.exists(file_path):
            await update.message.reply_video(video=open(file_path, "rb"))
            os.remove(file_path)
        else:
            await update.message.reply_text("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„.")
    except subprocess.CalledProcessError as e:
        await update.message.reply_text(f"âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ:\n{str(e)}")
    except Exception as e:
        await update.message.reply_text(f"âŒ Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹:\n{str(e)}")

# ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª
def main():
    app = Application.builder().token(TOKEN).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("usage", usage))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_video))
    app.run_polling()

if __name__ == "__main__":
    main()
